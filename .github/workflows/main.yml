name: Daily Build Check

on:
  schedule:
    - cron: '0 2 1,15 * *'
  workflow_dispatch:

jobs:
  build-check:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 23
        uses: actions/setup-java@v4
        with:
          java-version: '23'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Create local.properties with required values
        run: |
          cat > local.properties << EOF
          sdk.dir=/opt/android-sdk-linux
          RELEASE_STORE_FILE=dummy.jks
          RELEASE_STORE_PASSWORD=dummy123
          RELEASE_KEY_ALIAS=dummy
          RELEASE_KEY_PASSWORD=dummy123
          base64_of_encoded_decryption_key=dummy_key
          base64_of_encoded_verification_key=dummy_verification
          EOF

      - name: Create dummy keystore
        run: |
          keytool -genkeypair -v -keystore dummy.jks -keyalg RSA -keysize 2048 -validity 10000 -alias dummy -storepass dummy123 -keypass dummy123 -dname "CN=Dummy, OU=Dummy, O=Dummy, L=Dummy, S=Dummy, C=US"

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Tests
        run: ./gradlew test --stacktrace

      - name: Build Debug APK
        run: ./gradlew assembleDebug --stacktrace

      # Láº¥y thÃ´ng tin version tá»« build.gradle
      - name: Get version info
        id: version
        run: |
          # Extract version from root build.gradle.kts
          VERSION_NAME=$(grep -A5 'val versionInfo = mapOf' build.gradle.kts | grep -E '"major"|"minor"|"patch"' | grep -o '[0-9]\+' | tr '\n' '.' | sed 's/\.$//')

          # If extraction fails, use default
          if [ -z "$VERSION_NAME" ] || [ "$VERSION_NAME" = ".." ]; then
            VERSION_NAME="1.0.0"
          fi

          # Extract version code from the calculation
          VERSION_CODE=$(grep 'versionCode = rootProject.extra\["versionCode"\]' app/build.gradle.kts -A5 -B5 | head -10)
          if [ -z "$VERSION_CODE" ]; then
            # Calculate from root build.gradle.kts
            MAJOR=$(grep '"major" to' build.gradle.kts | grep -o '[0-9]\+')
            MINOR=$(grep '"minor" to' build.gradle.kts | grep -o '[0-9]\+')
            PATCH=$(grep '"patch" to' build.gradle.kts | grep -o '[0-9]\+')
            BUILD=$(grep '"build" to' build.gradle.kts | grep -o '[0-9]\+')

            if [ -n "$MAJOR" ] && [ -n "$MINOR" ] && [ -n "$PATCH" ] && [ -n "$BUILD" ]; then
              VERSION_CODE=$((MAJOR * 1000000 + MINOR * 10000 + PATCH * 100 + BUILD))
            else
              VERSION_CODE="1"
            fi
          fi

          COMMIT_SHORT=$(git rev-parse --short HEAD)
          DATE=$(date +%Y%m%d)

          # Create clean tag name with proper format
          TAG_NAME="v${VERSION_NAME}-${DATE}-${COMMIT_SHORT}"

          echo "version_name=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "version_code=${VERSION_CODE}" >> $GITHUB_OUTPUT
          echo "commit_short=${COMMIT_SHORT}" >> $GITHUB_OUTPUT
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "date=${DATE}" >> $GITHUB_OUTPUT

          echo "Version Name: $VERSION_NAME"
          echo "Version Code: $VERSION_CODE"
          echo "Tag Name: $TAG_NAME"

      # TÃ¬m file APK Ä‘Æ°á»£c táº¡o
      - name: Find APK file
        id: apk_file
        run: |
          APK_PATH=$(find app/build/outputs/apk/debug -name "*.apk" | head -1)
          APK_NAME=$(basename "$APK_PATH")
          NEW_APK_NAME="app-debug-v${{ steps.version.outputs.version_name }}-${{ steps.version.outputs.date }}.apk"
          cp "$APK_PATH" "$NEW_APK_NAME"
          echo "apk_path=${NEW_APK_NAME}" >> $GITHUB_OUTPUT
          echo "apk_name=${NEW_APK_NAME}" >> $GITHUB_OUTPUT

      # Táº¡o release vá»›i APK
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: ${{ steps.version.outputs.tag_name }} | HOTFIX
          body: |
            ðŸš€ **Automated Daily Build**
            
            **Build Info:**
            - Version: ${{ steps.version.outputs.version_name }}
            - Version Code: ${{ steps.version.outputs.version_code }}
            - Commit: ${{ steps.version.outputs.commit_short }}
            - Build Date: ${{ steps.version.outputs.date }}
            
            **Changes:**
            - Daily automated build check
            - All tests passed âœ…
            
            **Download:**
            - Debug APK available below
          files: ${{ steps.apk_file.outputs.apk_path }}
          draft: false
          prerelease: false

      # Upload APK nhÆ° artifact (backup)
      - name: Upload APK as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk-${{ steps.version.outputs.tag_name }}
          path: ${{ steps.apk_file.outputs.apk_path }}
          retention-days: 30

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Build failed! Check the logs for details."
          echo "Build failed at $(date)"

      # ThÃ´ng bÃ¡o thÃ nh cÃ´ng
      - name: Notify on success
        if: success()
        run: |
          echo "::notice::âœ… Build completed successfully!"
          echo "::notice::Release created: ${{ steps.version.outputs.tag_name }}"
          echo "::notice::APK: ${{ steps.apk_file.outputs.apk_name }}"